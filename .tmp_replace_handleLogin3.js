const fs = require('fs');
const path = 'src/components/login/LoginForm.jsx';
let code = fs.readFileSync(path, 'utf8');
const start = code.indexOf('const handleLogin = async');
if (start === -1) throw new Error('handleLogin start not found');
const returnIdx = code.indexOf('\n  return (', start);
if (returnIdx === -1) throw new Error('return block after handleLogin not found');
const oldBlock = code.slice(start, returnIdx);
const newBlock = `const handleLogin = async (email, password) => {\r\n  if (isLoggingIn) {\r\n    return;\r\n  }\r\n\r\n  setIsLoggingIn(true);\r\n  Keyboard.dismiss();\r\n\r\n  try {\r\n    const approval = await checkUserApprovalStatus(email);\r\n\r\n    if (!approval.exists || approval.error) {\r\n      handleDataError('Impossibile trovare i dati del tuo account. Contatta il supporto.');\r\n      if (approval?.error) {\r\n        console.error('User approval lookup error:', approval.error);\r\n      }\r\n      return;\r\n    }\r\n\r\n    if (!approval.isApproved) {\r\n      const message =\r\n        approval.status === 'pending'\r\n          ? "Il tuo account e in attesa di approvazione da parte di un amministratore. Riceverai una notifica quando potrai effettuare l'accesso."\r\n          : "Il tuo account non e autorizzato ad accedere all'app. Contatta un amministratore per assistenza.";\r\n\r\n      handleDataError(message);\r\n\r\n      if (approval.status === 'pending') {\r\n        navigation.navigate('PendingApproval');\r\n      }\r\n      return;\r\n    }\r\n\r\n    const credentials = await firebase.auth().signInWithEmailAndPassword(email, password);\r\n\r\n    if (approval.status !== 'approved' && approval.userDocRef) {\r\n      try {\r\n        await approval.userDocRef.set(\r\n          {\r\n            status: 'approved',\r\n            approvedAt:\r\n              approval.rawApprovedAt || firebase.firestore.FieldValue.serverTimestamp(),\r\n          },\r\n          { merge: true }\r\n        );\r\n      } catch (statusSyncError) {\r\n        console.warn('Unable to sync user approval status:', statusSyncError);\r\n      }\r\n    }\r\n\r\n    const appwriteData = await createAppwriteSession(email, password);\r\n\r\n    const userData = {\r\n      uid: credentials.user.uid,\r\n      email: credentials.user.email,\r\n      appwriteUserId: appwriteData.userId,\r\n      appwriteSessionId: appwriteData.sessionId,\r\n      appwriteExpire: appwriteData.expire,\r\n      appwriteSecret: appwriteData.secret,\r\n      loginTimestamp: new Date().toISOString(),\r\n      appwriteUserData: {\r\n        name: appwriteData.appwriteUser.name || '',\r\n        emailVerification: appwriteData.appwriteUser.emailVerification || false,\r\n        status: appwriteData.appwriteUser.status || false,\r\n      },\r\n    };\r\n\r\n    await saveUserSecurely(userData, password);\r\n  } catch (error) {\r\n    console.error('Login error:', error);\r\n\r\n    try {\r\n      if (firebase.auth().currentUser) {\r\n        await firebase.auth().signOut();\r\n      }\r\n      await appwriteAccount.deleteSession('current').catch(() => {});\r\n    } catch (cleanupError) {\r\n      console.warn('Cleanup after login failure failed:', cleanupError);\r\n    }\r\n\r\n    if (error?.code) {\r\n      handleDataError(getFirebaseErrorMessage(error));\r\n      if (error.code === 'auth/user-disabled') {\r\n        navigation.navigate('PendingApproval');\r\n      }\r\n    } else {\r\n      handleDataError('Si e verificato un errore durante il login. Riprova.');\r\n    }\r\n  } finally {\r\n    setIsLoggingIn(false);\r\n  }\r\n};\r\n`;
code = code.replace(oldBlock, newBlock);
fs.writeFileSync(path, code);
